select
pref.id,
coalesce(crc.datecancelled::date,fail.datereceived::date) as "Rc_Bios__End_Date",
'FALSE' as "Rc_Bios__Active",
(case when crc.recurringcontributionstatusname='Inactive--Failed' then 'Preference closed due to excessive failures in EveryAction'
when crc.recurringcontributionstatusname='Inactive--Cancelled' then 'Online classification closed due to termination' else null end) as "Rc_Bios__Comments"

from 
/* EA inactive sustaining gifts, excluding donors with still active gifts */
(select a.vanid, a.contactsrecurringcontributionid, a.datecancelled, b.recurringcontributionstatusname
 from vansync.ppfa_contactsrecurringcontributions_mym a
 inner join vansync.ppfa_recurringcontributionstatuses b using (recurringcontributionstatusid)
 left join
 (select * from vansync.ppfa_contactsrecurringcontributions_mym 
  where recurringcontributionstatusid in (1,5)
and committeeid in (11607,9816,72220,72219)) c on a.vanid=c.vanid
 where a.recurringcontributionstatusid in (2,4)
 and a.committeeid in (11607,9816,72220,72219)
and c.vanid is null) crc

/* get date of most recent failed installment */
inner join 
(SELECT *
FROM (select contactsrecurringcontributionid, datereceived, row_number() OVER (PARTITION BY contactsrecurringcontributionid ORDER BY datereceived desc) as rownumber
from vansync.ppfa_contactscontributions_mym
where contributionstatusid = 4)
WHERE rownumber=1) fail using (contactsrecurringcontributionid)

/* get rD account id from alternate id table */
inner join
(select accountx, valuex from rounddata.alternate_id where typex='Van') alt on crc.vanid=alt.valuex

/* rD preference */
inner join
(select id, rc_bios__account from rounddata.rc_bios__preference 
where rc_bios__code_value in ('SUS NL C3 ONLINE','SUS NL C4 ONLINE')
and rc_bios__active='true'
and delete_flag<>'Y') pref on pref.rc_bios__account=alt.accountx

/* only pull newly inactive gifts from last month */
where date_part(month, coalesce(crc.datecancelled::date,fail.datereceived::date))= (date_part(month,current_date)-1)